name: Release

on:
  workflow_dispatch:
  push:
    tags:
      - "v*"

permissions:
  contents: write

jobs:
  build:
    runs-on: macos-15
    outputs:
      sha256: ${{ steps.sha.outputs.sha256 }}
    steps:
      - uses: actions/checkout@v6

      - name: Select Xcode
        run: sudo xcode-select -s /Applications/Xcode_16.4.app/Contents/Developer

      - name: Build archive
        run: |
          xcodebuild archive \
            -scheme StandBy \
            -destination 'generic/platform=macOS' \
            -archivePath $RUNNER_TEMP/StandBy.xcarchive \
            CODE_SIGN_IDENTITY="-" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=YES

      - name: Create zip
        run: |
          ditto -c -k --sequesterRsrc --keepParent \
            $RUNNER_TEMP/StandBy.xcarchive/Products/Applications/StandBy.app \
            $RUNNER_TEMP/StandBy.app.zip

      - name: Calculate SHA256
        id: sha
        run: |
          SHA=$(shasum -a 256 $RUNNER_TEMP/StandBy.app.zip | awk '{ print $1 }')
          echo "sha256=$SHA" >> "$GITHUB_OUTPUT"

      - name: Upload artifact
        uses: actions/upload-artifact@v7
        with:
          name: StandBy.app.zip
          path: ${{ runner.temp }}/StandBy.app.zip

  release:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Download artifact
        uses: actions/download-artifact@v8
        with:
          name: StandBy.app.zip

      - name: Create GitHub Release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release create "${{ github.ref_name }}" \
            StandBy.app.zip \
            --title "${{ github.ref_name }}" \
            --generate-notes

  update-tap:
    needs: [build, release]
    runs-on: ubuntu-latest
    steps:
      - name: Update Homebrew Cask
        env:
          GH_TOKEN: ${{ secrets.TAP_GITHUB_TOKEN }}
        run: |
          TAG="${{ github.ref_name }}"
          VERSION="${TAG#v}"
          SHA="${{ needs.build.outputs.sha256 }}"

          git clone "https://x-access-token:${GH_TOKEN}@github.com/mickamy/homebrew-tap.git"
          cd homebrew-tap

          mkdir -p Casks

          cat > Casks/standby.rb <<CASK
          cask "standby" do
            version "${VERSION}"
            sha256 "${SHA}"

            url "https://github.com/mickamy/StandBy/releases/download/v#{version}/StandBy.app.zip"
            name "StandBy"
            desc "macOS menu bar app that reminds you to stretch"
            homepage "https://github.com/mickamy/StandBy"

            app "StandBy.app"

            postflight do
              system_command "/usr/bin/xattr",
                             args: ["-cr", "#{appdir}/StandBy.app"]
            end

            zap trash: [
              "~/Library/Preferences/com.mickamy.StandBy.plist",
            ]
          end
          CASK

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add Casks/standby.rb
          git commit -m "Update standby to ${VERSION}"
          git push
