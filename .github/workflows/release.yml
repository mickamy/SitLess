name: Release

on:
  workflow_dispatch:
  push:
    tags:
      - "v*"

permissions:
  contents: write

jobs:
  build:
    runs-on: macos-15
    outputs:
      sha256: ${{ steps.sha.outputs.sha256 }}
    steps:
      - uses: actions/checkout@v6

      - name: Select Xcode
        run: sudo xcode-select -s /Applications/Xcode_16.4.app/Contents/Developer

      - name: Build archive
        run: |
          xcodebuild archive \
            -scheme SitLess \
            -destination 'generic/platform=macOS' \
            -archivePath $RUNNER_TEMP/SitLess.xcarchive \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO

      - name: Create zip
        run: |
          ditto -c -k --sequesterRsrc --keepParent \
            $RUNNER_TEMP/SitLess.xcarchive/Products/Applications/SitLess.app \
            $RUNNER_TEMP/SitLess.app.zip

      - name: Calculate SHA256
        id: sha
        run: |
          SHA=$(shasum -a 256 $RUNNER_TEMP/SitLess.app.zip | awk '{ print $1 }')
          echo "sha256=$SHA" >> "$GITHUB_OUTPUT"

      - name: Upload artifact
        uses: actions/upload-artifact@v7
        with:
          name: SitLess.app.zip
          path: ${{ runner.temp }}/SitLess.app.zip

  release:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Download artifact
        uses: actions/download-artifact@v8
        with:
          name: SitLess.app.zip

      - name: Create GitHub Release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release create "${{ github.ref_name }}" \
            SitLess.app.zip \
            --title "${{ github.ref_name }}" \
            --generate-notes

  update-tap:
    needs: [build, release]
    runs-on: ubuntu-latest
    steps:
      - name: Update Homebrew Cask
        env:
          GH_TOKEN: ${{ secrets.TAP_GITHUB_TOKEN }}
        run: |
          TAG="${{ github.ref_name }}"
          VERSION="${TAG#v}"
          SHA="${{ needs.build.outputs.sha256 }}"

          git clone "https://x-access-token:${GH_TOKEN}@github.com/mickamy/homebrew-tap.git"
          cd homebrew-tap

          mkdir -p Casks

          cat > Casks/sitless.rb <<CASK
          cask "sitless" do
            version "${VERSION}"
            sha256 "${SHA}"

            url "https://github.com/mickamy/SitLess/releases/download/v#{version}/SitLess.app.zip"
            name "SitLess"
            desc "macOS menu bar app that reminds you to stretch"
            homepage "https://github.com/mickamy/SitLess"

            app "SitLess.app"

            postflight do
              system_command "/usr/bin/xattr",
                             args: ["-cr", "#{appdir}/SitLess.app"]
            end

            zap trash: [
              "~/Library/Preferences/com.mickamy.SitLess.plist",
            ]
          end
          CASK

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add Casks/sitless.rb
          git commit -m "Update sitless to ${VERSION}"
          git push
